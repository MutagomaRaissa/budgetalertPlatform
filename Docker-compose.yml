version: "3.9"

services:
  # --------------------
  # Consul Service Discovery
  # --------------------
  consul:
    image: hashicorp/consul:1.19
    container_name: budget-consul
    ports:
      - "8500:8500"
    command: consul agent -dev -client=0.0.0.0
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8500/v1/status/leader || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - main-network

  # --------------------
  # Project Database
  # --------------------
  project-db:
    image: postgres:15-alpine
    container_name: project-db
    environment:
      POSTGRES_DB: projectdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - project-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d projectdb"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - main-network

  # --------------------
  # Coverage Database
  # --------------------
  coverage-db:
    image: postgres:15-alpine
    container_name: coverage-db
    environment:
      POSTGRES_DB: coveragedb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - coverage-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d coveragedb"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - main-network

  # --------------------
  # Alert Database
  # --------------------
  alert-db:
    image: postgres:15-alpine
    container_name: alert-db
    environment:
      POSTGRES_DB: alertdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - alert-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d alertdb"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - main-network

  # --------------------
  # Project Service
  # --------------------
  project-service:
    build:
      context: ./projectservice
      dockerfile: Dockerfile
    container_name: project-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:postgresql://project-db:5432/projectdb
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      CONSUL_HOST: consul
      CONSUL_PORT: 8500
      SERVER_PORT: 8081
    ports:
      - "8081:8081"
    depends_on:
      consul:
        condition: service_healthy
      project-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8081/actuator/health || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
    networks:
      - main-network

  # --------------------
  # Coverage Service
  # --------------------
  coverage-service:
    build:
      context: ./coverageService
      dockerfile: Dockerfile
    container_name: coverage-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:postgresql://coverage-db:5432/coveragedb
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      CONSUL_HOST: consul
      CONSUL_PORT: 8500
      SERVER_PORT: 8082
    ports:
      - "8082:8082"
    depends_on:
      consul:
        condition: service_healthy
      coverage-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8082/actuator/health || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
    networks:
      - main-network

  # --------------------
  # Alert Service
  # --------------------
  alert-service:
    build:
      context: ./alertService
      dockerfile: Dockerfile
    container_name: alert-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:postgresql://alert-db:5432/alertdb
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      CONSUL_HOST: consul
      CONSUL_PORT: 8500
      SERVER_PORT: 8083
    ports:
      - "8083:8083"
    depends_on:
      consul:
        condition: service_healthy
      alert-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8083/actuator/health || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
    networks:
      - main-network

  # --------------------
  # API Gateway
  # --------------------
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    environment:
      SPRING_PROFILES_ACTIVE: prod
      CONSUL_HOST: consul
      CONSUL_PORT: 8500
      SERVER_PORT: 8080
    ports:
      - "8080:8080"
    depends_on:
      consul:
        condition: service_healthy
      project-service:
        condition: service_healthy
      coverage-service:
        condition: service_healthy
      alert-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
    networks:
      - main-network

# --------------------
# Volumes for databases
# --------------------
volumes:
  project-db-data:
  coverage-db-data:
  alert-db-data:

# --------------------
# Single Network for all services
# --------------------
networks:
  main-network:
    driver: bridge
